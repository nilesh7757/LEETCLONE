generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Problem {
  id                String             @id @default(uuid())
  title             String
  slug              String             @unique
  difficulty        String
  category          String
  description       String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  referenceSolution String?
  testSets          Json               @default("[]")
  memoryLimit       Int                @default(256)
  timeLimit         Int                @default(2)
  isPublic          Boolean            @default(true)
  creatorId         String?
  editorial         String?
  type              ProblemType        @default(CODING)
  initialData       String?
  initialSchema     String?
  hints             String[]           @default([])
  blueprint         Json?
  pattern           String?
  isVerified        Boolean            @default(true)
  source            String             @default("SYSTEM")
  lastAiFeedback    String?
  blogPosts         BlogPost[]
  comments          Comment[]
  Draft             Draft[]
  creator           User?              @relation("CreatedProblems", fields: [creatorId], references: [id])
  studyPlans        StudyPlanProblem[]
  submissions       Submission[]
  contests          Contest[]          @relation("ContestToProblem")

  @@index([difficulty, category, isPublic])
  @@index([type])
}

model StudyPlan {
  id           String                @id @default(uuid())
  title        String
  slug         String                @unique
  description  String
  coverImage   String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  durationDays Int?
  creatorId    String?
  isPublic     Boolean               @default(false)
  isOfficial   Boolean               @default(false)
  pendingData  Json?
  status       String                @default("DRAFT")
  creator      User?                 @relation("CreatedStudyPlans", fields: [creatorId], references: [id])
  enrollments  StudyPlanEnrollment[]
  problems     StudyPlanProblem[]
}

model StudyPlanProblem {
  id          String    @id @default(uuid())
  studyPlanId String
  problemId   String
  order       Int       @default(0)
  problem     Problem   @relation(fields: [problemId], references: [id], onDelete: Cascade)
  studyPlan   StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)

  @@unique([studyPlanId, problemId])
}

model StudyPlanEnrollment {
  id           String    @id @default(uuid())
  userId       String
  studyPlanId  String
  enrolledAt   DateTime  @default(now())
  reminderTime String?
  isActive     Boolean   @default(true)
  studyPlan    StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, studyPlanId])
}

model Comment {
  id         String        @id @default(uuid())
  content    String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  problemId  String?
  userId     String
  parentId   String?
  blogPostId String?
  blogPost   BlogPost?     @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  parent     Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  children   Comment[]     @relation("CommentReplies")
  problem    Problem?      @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes      CommentVote[]

  @@index([problemId])
  @@index([blogPostId])
  @@index([parentId])
}

model CommentVote {
  id        String  @id @default(uuid())
  type      String
  userId    String
  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
}

model UserRatingHistory {
  id           String   @id @default(uuid())
  userId       String
  contestId    String
  ratingBefore Int
  ratingAfter  Int
  rank         Int
  date         DateTime @default(now())
  contest      Contest  @relation(fields: [contestId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
}

model Submission {
  id              String   @id @default(uuid())
  code            String
  language        String
  status          String
  runtime         Float?
  createdAt       DateTime @default(now())
  problemId       String
  userId          String?
  spaceComplexity String?
  timeComplexity  String?
  testCaseResults Json?
  score           Int?
  auditFeedback   String?
  auditPassed     Boolean? @default(true)
  reports         Report[]
  problem         Problem  @relation(fields: [problemId], references: [id])
  user            User?    @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([problemId, status])
  @@index([createdAt(sort: Desc)])
}

model User {
  id                   String                    @id @default(uuid())
  name                 String?
  email                String?                   @unique
  emailVerified        DateTime?
  image                String?
  password             String?
  bio                  String?
  website              String?
  description          String?
  rating               Int                       @default(1500)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime?                 @updatedAt
  role                 String                    @default("USER")
  isBanned             Boolean                   @default(false)
  warnings             Int                       @default(0)
  isVerified           Boolean                   @default(false)
  otp                  String?
  otpExpires           DateTime?
  resetToken           String?
  resetTokenExpires    DateTime?
  lastSolvedDate       DateTime?
  streak               Int                       @default(0)
  solvedCount          Int                       @default(0)
  lastActive           DateTime?                 @default(now())
  skills               String[]                  @default([])
  accounts             Account[]
  blogPosts            BlogPost[]
  comments             Comment[]
  commentVotes         CommentVote[]
  createdContests      Contest[]                 @relation("CreatedContests")
  registrations        ContestRegistration[]
  conversations        ConversationParticipant[]
  Draft                Draft[]
  messages             Message[]
  mockInterviews       MockInterview[]
  sentNotifications    Notification[]            @relation("UserSentNotifications")
  notifications        Notification[]            @relation("UserNotifications")
  createdProblems      Problem[]                 @relation("CreatedProblems")
  reportsMade          Report[]                  @relation("Reporter")
  sessions             Session[]
  snippets             Snippet[]
  createdStudyPlans    StudyPlan[]               @relation("CreatedStudyPlans")
  studyPlanEnrollments StudyPlanEnrollment[]
  submissions          Submission[]
  UserBadge            UserBadge[]
  ratingHistory        UserRatingHistory[]
  following            User[]                    @relation("UserFollows")
  followedBy           User[]                    @relation("UserFollows")

  @@index([rating(sort: Desc)])
  @@index([streak(sort: Desc)])
  @@index([solvedCount(sort: Desc)])
}

model MockInterview {
  id         String   @id @default(uuid())
  userId     String
  topic      String
  difficulty String
  status     String   @default("ONGOING")
  questions  Json
  answers    Json     @default("[]")
  score      Int?
  feedback   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  roadmap    Json?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  senderId  String?
  sender    User?    @relation("UserSentNotifications", fields: [senderId], references: [id], onDelete: Cascade)
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

model Conversation {
  id           String                    @id @default(uuid())
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  userId         String
  conversationId String
  lastReadAt     DateTime?    @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, conversationId])
}

model Message {
  id             String       @id @default(uuid())
  content        String?
  type           String       @default("TEXT")
  fileUrl        String?
  createdAt      DateTime     @default(now())
  senderId       String
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt(sort: Desc)])
}

model Report {
  id           String     @id @default(uuid())
  reason       String
  createdAt    DateTime   @default(now())
  status       String     @default("PENDING")
  submissionId String
  reporterId   String
  reporter     User       @relation("Reporter", fields: [reporterId], references: [id])
  submission   Submission @relation(fields: [submissionId], references: [id])
}

model Contest {
  id              String                @id @default(uuid())
  title           String
  description     String
  startTime       DateTime
  endTime         DateTime
  createdAt       DateTime              @default(now())
  creatorId       String
  publishProblems Boolean               @default(false)
  accessCode      String?
  visibility      String                @default("PUBLIC")
  isOfficial      Boolean               @default(false)
  blogPosts       BlogPost[]
  creator         User                  @relation("CreatedContests", fields: [creatorId], references: [id])
  registrations   ContestRegistration[]
  ratingUpdates   UserRatingHistory[]
  problems        Problem[]             @relation("ContestToProblem")
}

model ContestRegistration {
  id           String   @id @default(uuid())
  userId       String
  contestId    String
  score        Int      @default(0)
  rank         Int?
  registeredAt DateTime @default(now())
  contest      Contest  @relation(fields: [contestId], references: [id])
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, contestId])
}

model BlogPost {
  id         String    @id @default(uuid())
  title      String
  slug       String    @unique
  content    String
  excerpt    String?
  coverImage String?
  published  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  authorId   String
  contestId  String?
  problemId  String?
  tags       String[]
  author     User      @relation(fields: [authorId], references: [id])
  contest    Contest?  @relation(fields: [contestId], references: [id])
  problem    Problem?  @relation(fields: [problemId], references: [id])
  comments   Comment[]
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Snippet {
  id        String   @id @default(uuid())
  title     String
  code      String
  language  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Badge {
  id          String      @id
  name        String      @unique
  description String
  icon        String
  category    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  UserBadge   UserBadge[]
}

model CodeCache {
  id        String   @id
  hash      String   @unique
  result    Json
  createdAt DateTime @default(now())
}

model Draft {
  id        String   @id
  userId    String
  problemId String
  code      String
  language  String
  updatedAt DateTime
  Problem   Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, problemId, language])
}

model UserBadge {
  id        String   @id
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  Badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

enum ProblemType {
  CODING
  SHELL
  INTERACTIVE
  SYSTEM_DESIGN
  SQL
  READING
}
